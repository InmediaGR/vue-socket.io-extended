String.prototype.startsWith||(String.prototype.startsWith=function(t,e){return this.substr(!e||e<0?0:+e,t.length)===t});var preserveCamelCase=function(t){for(var e=!1,n=!1,r=!1,o=0;o<t.length;o++){var i=t[o];e&&/[a-zA-Z]/.test(i)&&i.toUpperCase()===i?(t=t.slice(0,o)+"-"+t.slice(o),e=!1,r=n,n=!0,o++):n&&r&&/[a-zA-Z]/.test(i)&&i.toLowerCase()===i?(t=t.slice(0,o-1)+"-"+t.slice(o-1),r=n,n=!1,e=!0):(e=i.toLowerCase()===i,r=n,n=i.toUpperCase()===i)}return t},camelcase=function(t,e){e=Object.assign({pascalCase:!1},e);var n=function(t){return e.pascalCase?t.charAt(0).toUpperCase()+t.slice(1):t};return 0===(t=Array.isArray(t)?t.map(function(t){return t.trim()}).filter(function(t){return t.length}).join("-"):t.trim()).length?"":1===t.length?e.pascalCase?t.toUpperCase():t.toLowerCase():/^[a-z\d]+$/.test(t)?n(t):(t!==t.toLowerCase()&&(t=preserveCamelCase(t)),n(t=t.replace(/^[_.\- ]+/,"").toLowerCase().replace(/[_.\- ]+(\w|$)/g,function(t,e){return e.toUpperCase()})))},eventToAction=function(t){return"socket_"+camelcase(t.replace("SOCKET",""))},isFunction=function(t){return"function"==typeof t},isSocketIo=function(t){return!!t&&isFunction(t.on)&&isFunction(t.emit)},unwrapIfSingle=function(t){return t&&t.length<=1?t[0]:t},classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),toArray=function(t){return Array.isArray(t)?t:Array.from(t)},toConsumableArray=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},EventEmitter=function(){function t(){classCallCheck(this,t),this.listeners=new Map}return createClass(t,[{key:"addListener",value:function(t,e,n){isFunction(e)&&(this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push({callback:e,vm:n}))}},{key:"removeListener",value:function(t,e,n){if(isFunction(e)){var r=(this.listeners.get(t)||[]).filter(function(t){return t.callback!==e||t.vm!==n});r.length>0?this.listeners.set(t,r):this.listeners.delete(t)}}},{key:"emit",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];(this.listeners.get(t)||[]).forEach(function(t){var e;(e=t.callback).call.apply(e,[t.vm].concat(n))})}}]),t}(),GlobalEmitter=new EventEmitter,SYSTEM_EVENTS=["connect","error","disconnect","reconnect","reconnect_attempt","reconnecting","reconnect_error","reconnect_failed","connect_error","connect_timeout","connecting","ping","pong"],Observer=function(){function t(e,n){classCallCheck(this,t),this.Socket=e,n&&(this.store=n),this.registerEventHandler()}return createClass(t,[{key:"registerEventHandler",value:function(){var t=this,e=this.Socket.onevent;this.Socket.onevent=function(n){e.call(t.Socket,n),GlobalEmitter.emit.apply(GlobalEmitter,toConsumableArray(n.data));var r=toArray(n.data),o=r[0],i=r.slice(1);t.passToStore("SOCKET_"+o,[].concat(toConsumableArray(i)))},SYSTEM_EVENTS.forEach(function(e){t.Socket.on(e,function(){for(var n=arguments.length,r=Array(n),o=0;o<n;o++)r[o]=arguments[o];GlobalEmitter.emit.apply(GlobalEmitter,[e].concat(r)),t.passToStore("SOCKET_"+e,[].concat(r))})})}},{key:"passToStore",value:function(t,e){var n=this;if(this.store&&t.startsWith("SOCKET_")){var r=unwrapIfSingle(e);Object.keys(this.store._mutations).forEach(function(e){e.split("/").pop()===t.toUpperCase()&&n.store.commit(e,r)}),Object.keys(this.store._actions).forEach(function(e){var o=e.split("/").pop();o.startsWith("socket_")&&(o===eventToAction(t)&&n.store.dispatch(e,r))})}}}]),t}(),mixin=function(t){return{created:function(){var e=this,n=this.$options.sockets,r=void 0===n?{}:n;Object.keys(r).forEach(function(n){t.addListener(n,r[n],e)}),window.Proxy&&(this.$options.sockets=new Proxy(r,{set:function(n,r,o){return t.addListener(r,o,e),n[r]=o,!0},deleteProperty:function(n,r){return t.removeListener(r,e.$options.sockets[r],e),delete n.key,!0}}))},beforeDestroy:function(){var e=this,n=this.$options.sockets,r=void 0===n?{}:n;Object.keys(r).forEach(function(n){window.Proxy||t.removeListener(n,r[n],e),delete e.$options.sockets[n]})}}},Main={install:function(t,e,n){if(!isSocketIo(e))throw new Error("[vue-socket.io-ext] you have to pass `socket.io-client` instance to the plugin");var r=new Observer(e,n);t.prototype.$socket=r.Socket,t.mixin(mixin(GlobalEmitter))}};export default Main;
