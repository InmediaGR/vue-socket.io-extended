var classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},EventEmitter=function(){function e(){classCallCheck(this,e),this.listeners=new Map}return createClass(e,[{key:"addListener",value:function(e,t,n){return"function"==typeof t&&(this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push({callback:t,vm:n}),!0)}},{key:"removeListener",value:function(e,t,n){var r=this.listeners.get(e),o=void 0;return!!(r&&r.length&&(o=r.reduce(function(e,r,o){return"function"==typeof r.callback&&r.callback===t&&r.vm==n?e=o:e},-1))>-1)&&(r.splice(o,1),this.listeners.set(e,r),!0)}},{key:"emit",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var o=this.listeners.get(e);return!(!o||!o.length)&&(o.forEach(function(e){var t;(t=e.callback).call.apply(t,[e.vm].concat(n))}),!0)}}]),e}(),GlobalEmitter=new EventEmitter,preserveCamelCase=function(e){for(var t=!1,n=!1,r=!1,o=0;o<e.length;o++){var s=e[o];t&&/[a-zA-Z]/.test(s)&&s.toUpperCase()===s?(e=e.slice(0,o)+"-"+e.slice(o),t=!1,r=n,n=!0,o++):n&&r&&/[a-zA-Z]/.test(s)&&s.toLowerCase()===s?(e=e.slice(0,o-1)+"-"+e.slice(o-1),r=n,n=!1,t=!0):(t=s.toLowerCase()===s,r=n,n=s.toUpperCase()===s)}return e},camelcase=function(e,t){t=Object.assign({pascalCase:!1},t);var n=function(e){return t.pascalCase?e.charAt(0).toUpperCase()+e.slice(1):e};return 0===(e=Array.isArray(e)?e.map(function(e){return e.trim()}).filter(function(e){return e.length}).join("-"):e.trim()).length?"":1===e.length?t.pascalCase?e.toUpperCase():e.toLowerCase():/^[a-z\d]+$/.test(e)?n(e):(e!==e.toLowerCase()&&(e=preserveCamelCase(e)),n(e=e.replace(/^[_.\- ]+/,"").toLowerCase().replace(/[_.\- ]+(\w|$)/g,function(e,t){return t.toUpperCase()})))},eventToAction=function(e){return"socket_"+camelcase(e.replace("SOCKET",""))},isFunction=function(e){return"function"==typeof e},isSocketIo=function(e){return!!e&&isFunction(e.on)&&isFunction(e.emit)},SYSTEM_EVENTS=["connect","error","disconnect","reconnect","reconnect_attempt","reconnecting","reconnect_error","reconnect_failed","connect_error","connect_timeout","connecting","ping","pong"],Observer=function(){function e(t,n){classCallCheck(this,e),this.Socket=t,n&&(this.store=n),this.registerEventHandler()}return createClass(e,[{key:"registerEventHandler",value:function(){var e=this,t=this.Socket.onevent;this.Socket.onevent=function(n){t.call(e.Socket,n),GlobalEmitter.emit.apply(GlobalEmitter,toConsumableArray(n.data)),e.store&&e.passToStore("SOCKET_"+n.data[0],[].concat(toConsumableArray(n.data.slice(1))))};var n=this;SYSTEM_EVENTS.forEach(function(e){n.Socket.on(e,function(t){GlobalEmitter.emit(e,t),n.store&&n.passToStore("SOCKET_"+e,t)})})}},{key:"passToStore",value:function(e,t){if(e.startsWith("SOCKET_")){for(var n in this.store._mutations){n.split("/").pop()===e.toUpperCase()&&this.store.commit(n,t)}for(var r in this.store._actions){var o=r.split("/").pop();if(o.startsWith("socket_"))o===eventToAction(e)&&this.store.dispatch(r,t)}}}}]),e}(),mixin=function(e){return{created:function(){var t=this,n=this.$options.sockets;this.$options.sockets=new Proxy({},{set:function(n,r,o){return e.addListener(r,o,t),n[r]=o,!0},deleteProperty:function(n,r){return e.removeListener(r,t.$options.sockets[r],t),delete n.key,!0}}),n&&Object.keys(n).forEach(function(e){t.$options.sockets[e]=n[e]})},beforeDestroy:function(){var e=this,t=this.$options.sockets;t&&Object.keys(t).forEach(function(t){delete e.$options.sockets[t]})}}},Main={install:function(e,t,n){if(!isSocketIo(t))throw new Error("[vue-socket.io-ext] you have to pass `socket.io-client` instance to the plugin");var r=new Observer(t,n);e.prototype.$socket=r.Socket,e.mixin(mixin(GlobalEmitter))}};export default Main;
